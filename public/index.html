<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Banking App</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <h1>Welcome to Our Bank</h1>
    <p>Please choose an option below to proceed:</p>

    <!-- Navigation Buttons -->
    <div class="options">
      <button onclick="showSection('login')">Login</button>
      <button onclick="showSection('open')">Open Account</button>
      <button onclick="showSection('deposit')">Deposit</button>
      <button onclick="showSection('withdraw')">Withdraw</button>
      <button onclick="showSection('transfer')">Transfer</button>
      <button onclick="showSection('update')">Update PIN</button>
      <button onclick="showSection('delete')">Delete Account</button>
      <button onclick="showSection('history')">Transaction History</button>
    </div>

    <!-- Sections -->
    <div id="login" class="section">
      <h2>Login</h2>
      <input id="loginAcc" placeholder="Account Number">
      <input id="loginPin" placeholder="PIN" type="password">
      <button onclick="login()">Login</button>
    </div>

    <div id="open" class="section">
      <h2>Open Account</h2>
      <input id="name" placeholder="Name">
      <input id="pin" placeholder="PIN" type="password">
      <button onclick="openAccount()">Open Account</button>
    </div>

    <div id="deposit" class="section">
      <h2>Deposit</h2>
      <input id="depAmt" placeholder="Amount" type="number">
      <button onclick="deposit()">Deposit</button>
    </div>

    <div id="withdraw" class="section">
      <h2>Withdraw</h2>
      <input id="withAmt" placeholder="Amount" type="number">
      <button onclick="withdraw()">Withdraw</button>
    </div>

    <div id="transfer" class="section">
      <h2>Transfer</h2>
      <input id="toAcc" placeholder="To Account Number">
      <input id="transAmt" placeholder="Amount" type="number">
      <button onclick="transfer()">Transfer</button>
    </div>

    <div id="update" class="section">
      <h2>Update PIN</h2>
      <input id="newPin" placeholder="New PIN" type="password">
      <button onclick="updatePin()">Update PIN</button>
    </div>

    <div id="delete" class="section">
      <h2>Delete Account</h2>
      <button onclick="deleteAccount()">Delete Account</button>
    </div>

    <div id="history" class="section">
      <h2>Transaction History</h2>
      <ul id="transList"></ul>
      <p id="transError" style="color:red;"></p>
    </div>
  </div>

  <script>
    let token = ''; // JWT token stored after login
    const ACCOUNT_API = '/api/accounts';  // ✅ account routes
    const AUTH_API = '/api/auth';         // ✅ auth routes

    // Show only selected section
    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
      if (id) {
        document.getElementById(id).style.display = 'block';
        if (id === 'history') getTransactions();
      }
    }

    // ✅ Login (uses /api/auth/login)
    async function login() {
      const accountNumber = document.getElementById('loginAcc').value.trim();
      const pin = document.getElementById('loginPin').value.trim();

      if (!accountNumber || !pin) {
        alert('Please enter both account number and PIN');
        return;
      }

      try {
        const res = await fetch(`${AUTH_API}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountNumber, pin })
        });

        const data = await res.json();

        if (!res.ok) {
          alert('❌ Login failed: ' + data.message);
          return;
        }

        token = data.token;
        alert('✅ Login successful!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ✅ Open Account (uses /api/accounts/open)
    async function openAccount() {
      const name = document.getElementById('name').value.trim();
      const pin = document.getElementById('pin').value.trim();

      if (!name || !pin) {
        alert('Please enter both name and PIN');
        return;
      }

      try {
        const res = await fetch(`${ACCOUNT_API}/open`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, pin })
        });

        const data = await res.json();

        if (!res.ok) {
          alert('❌ ' + data.message);
          return;
        }

        alert(`✅ Account created successfully!\nYour Account Number: ${data.accountNumber}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ✅ Deposit
    async function deposit() {
      if (!token) return alert('Please login first');
      const amount = document.getElementById('depAmt').value;

      try {
        const res = await fetch(`${ACCOUNT_API}/deposit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ amount })
        });
        alert(await res.text());
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ✅ Withdraw
    async function withdraw() {
      if (!token) return alert('Please login first');
      const amount = document.getElementById('withAmt').value;

      try {
        const res = await fetch(`${ACCOUNT_API}/withdraw`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ amount })
        });
        alert(await res.text());
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ✅ Transfer
    async function transfer() {
      if (!token) return alert('Please login first');
      const toAccountNumber = document.getElementById('toAcc').value;
      const amount = document.getElementById('transAmt').value;

      try {
        const res = await fetch(`${ACCOUNT_API}/transfer`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ toAccountNumber, amount })
        });
        alert(await res.text());
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ✅ Update PIN
    async function updatePin() {
      if (!token) return alert('Please login first');
      const newPin = document.getElementById('newPin').value;

      try {
        const res = await fetch(`${ACCOUNT_API}/update-pin`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ newPin })
        });
        alert(await res.text());
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ✅ Delete Account
    async function deleteAccount() {
      if (!token) return alert('Please login first');
      try {
        const res = await fetch(`${ACCOUNT_API}/delete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });
        alert(await res.text());
        token = ''; // clear session
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // ✅ Transaction History
    async function getTransactions() {
      if (!token) return alert('Please login first');

      const list = document.getElementById('transList');
      const errorEl = document.getElementById('transError');
      list.innerHTML = '';
      errorEl.textContent = '';

      try {
        const res = await fetch('/api/transactions', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          const text = await res.text();
          errorEl.textContent = 'Error: ' + text;
          return;
        }

        const data = await res.json();

        if (!data.length) {
          list.innerHTML = '<li>No transactions found</li>';
          return;
        }

        data.forEach(t => {
          const li = document.createElement('li');
          li.textContent = `${new Date(t.date).toLocaleString()} - ${t.type.toUpperCase()} - ${t.amount}${t.toAccount ? ' → ' + t.toAccount : ''}`;
          list.appendChild(li);
        });
      } catch (err) {
        errorEl.textContent = 'Error: ' + err.message;
      }
    }

    // Hide all sections initially
    showSection('');
  </script>
</body>
</html>
